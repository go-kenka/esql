// Code generated by esql, DO NOT EDIT.
package {{.Name}}

import (
	"context"
	"entgo.io/ent/dialect/sql"
	"github.com/jmoiron/sqlx"
	"github.com/go-kenka/esql"
)

type {{.Name | camelCase}}Create struct {
	builder  *sql.InsertBuilder
	selector *sql.Selector
	db       esql.Driver
	data     *{{.Name | camelCase}}Data
}

func (c *{{.Name | camelCase}}Create) Set(column string, v any) *{{.Name | camelCase}}Create {
	c.builder.Set(column, v)
	return c
}

func (c *{{.Name | camelCase}}Create) Save(ctx context.Context) (*{{.Name | camelCase}}Data, error) {
	id, err := c.sqlSave(ctx)
	if err != nil {
		return nil, err
	}
	return c.get(ctx, id)
}

func (c *{{.Name | camelCase}}Create) sqlSave(ctx context.Context) (int, error) {
	query, args := c.builder.Query()
	result, err := c.db.ExecContext(ctx, query, args...)
	if err != nil {
		return 0, err
	}

	id, _ := result.LastInsertId()
	return int(id), nil
}

func (c *{{.Name | camelCase}}Create) sql() (string, []any) {
	return c.builder.Query()
}

func (c *{{.Name | camelCase}}Create) get(ctx context.Context, id int) (*{{.Name | camelCase}}Data, error) {
	query, args := c.selector.Where(sql.EQ(ColumnId, id)).Query()
	var data {{.Name | camelCase}}Data

	err := c.db.GetContext(ctx, &data, query, args...)
	if err != nil {
		return nil, err
	}

	return &data, nil
}

type {{.Name | camelCase}}CreateBulk struct {
	db       esql.Driver
	selector *sql.Selector
	data     []*{{.Name | camelCase}}Create
}

func (cb {{.Name | camelCase}}CreateBulk) Save(ctx context.Context) ([]*{{.Name | camelCase}}Data, error) {
	ids, err := cb.sqlSave(ctx)
	if err != nil {
		return nil, err
	}
	return cb.find(ctx, ids)
}
func (cb {{.Name | camelCase}}CreateBulk) sqlSave(ctx context.Context) ([]any, error) {
	var ids []any
	var stmt *sqlx.Stmt
	var err error
	for i, d := range cb.data {
		query, args := d.sql()
		if i == 0 {
			stmt, err = cb.db.Preparex(query)
			if err != nil {
				return nil, err
			}
		}
		if stmt != nil {
			result, err := stmt.ExecContext(ctx, args...)
			if err != nil {
				return nil, err
			}
			id, _ := result.LastInsertId()
			ids = append(ids, id)
		}
	}
	return ids, nil
}

func (cb {{.Name | camelCase}}CreateBulk) find(ctx context.Context, ids []any) ([]*{{.Name | camelCase}}Data, error) {
	query, args := cb.selector.Where(sql.In(ColumnId, ids...)).Query()
	var data []*{{.Name | camelCase}}Data
	err := cb.db.SelectContext(ctx, data, query, args...)
	if err != nil {
		return nil, err
	}
	return data, nil
}


